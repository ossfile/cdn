tbfine(["router","jsrender"],function(){return function(t){t.ajaxTransport("jsonpi",function(e,n,s){var a=e.jsonpCallback=jQuery.isFunction(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,i=window[a],r=e.url;return"GET"==e.type?e.params[e.jsonp]=a:r+=(/\?/.test(r)?"&":"?")+e.jsonp+"="+a,{send:function(n,s){var o,u,p="jQuery_iframe_"+jQuery.now();window[a]=function(t){s(200,"success",{jsonpi:t}),o.remove(),u.remove(),window[a]=i},o=t('<iframe name="'+p+'">').appendTo("head"),u=t("<form>").attr("method",e.type).attr("action",r).attr("target",p),t.each(e.params,function(e,n){t("<input>").attr("type","hidden").attr("name",e).attr("value",n).appendTo(u)}),u.appendTo("body").submit()},abort:function(){}}})}(jQuery),{init:function(){!function(t){function e(e,n,i){s("posts"),t(".user-postmenu a").removeClass(),a(u);var o={action:"posts",status:e,paged:n};p||(o.first=!0),t.ajax({url:c,type:"POST",dataType:"json",data:o,success:function(s,o,l){!p&&s.menus&&(p=s.menus),(p||!p&&s.menus)&&!t(".user-postmenu").length&&(u.before('<div class="user-postmenu"></div>'),t(".user-postmenu").html(t("#temp-postmenu").render(p||s.menus))),s.items?(u.html('<ul class="user-postlist"></ul>'),t(".user-postlist").html(t("#temp-postitem").render(s.items)).after(r(s.max,n,"#posts/"+e+"/")),tbquire(["lazyload"],function(){t(".user-main .thumb").lazyload({data_attribute:"src",placeholder:TBUI.uri+"/img/thumbnail.png",threshold:400})})):a(u,d[1201]),i&&i()},error:function(t,e,n){a(u,d[1079])}})}function n(e){s("comments"),a(u),t.ajax({url:c,type:"POST",dataType:"json",data:{action:"comments",paged:e},success:function(n,s,i){n.items?(u.html('<ul class="user-commentlist"></ul>'),t(".user-commentlist").html(t("#temp-commentitem").render(n.items)).after(r(n.max,e,"#comments/"))):a(u,d[1301])},error:function(t,e,n){a(u,d[1079])}})}function s(e){t(".usermenus li").removeClass("active"),t(".usermenu-"+e).addClass("active")}function a(t,e){e||(e='<i class="fa fa-spinner fa-spin" style="position:relative;top:1px;margin-right:5px;"></i> 数据加载中'),t.html('<div class="user-loading">'+e+"</div>")}function r(t,e,n,s){if(s||(s=10),!(t<=s)){t=Math.ceil(t/s);var a='<div class="pagination user-pagination"><ul>';for(e||(e=1),(e=Number(e))>3&&(a+='<li><a href="'+n+'1">1</a></li>'),e>4&&(a+="<li><span>...</span></li>"),i=e-2;i<=e+2;i++)i>0&&i<=t&&(a+=i==e?'<li class="active"><span>'+i+"</span></li>":'<li><a href="'+n+i+'">'+i+"</a></li>");return e<t-2-1&&(a+="<li><span>...</span></li>"),e<t-2&&(a+='<li><a href="'+n+t+'">'+t+"</a></li>"),a+="<li><span>共"+t+"页</span></li>",a+="</ul></div>"}}function o(e){if(!e)return!1;h&&clearTimeout(h),t(".user-tips").html(e).animate({top:0},220),h=setTimeout(function(){t(".user-tips").animate({top:-30},220)},5e3)}t("#contentframe");var u=t(".user-main"),p=null,l=null,c=TBUI.uri+"/action/user.php",d={1101:"该栏目下暂无数据！",1079:"服务器异常，请稍候再试！",1201:"暂无文章！",1301:"暂无评论！"},m={"posts/all":function(){e("all",1),t(".user-postmenu a:eq(0)").addClass("active")},"posts/all/:paged":function(n){e("all",n),t(".user-postmenu a:eq(0)").addClass("active")},"posts/publish":function(){e("publish",1),t(".user-postmenu a:eq(1)").addClass("active")},"posts/publish/:paged":function(n){e("publish",n),t(".user-postmenu a:eq(1)").addClass("active")},"posts/future":function(){e("future",1),t(".user-postmenu a:eq(2)").addClass("active")},"posts/future/:paged":function(n){e("future",n),t(".user-postmenu a:eq(2)").addClass("active")},"posts/pending":function(){e("pending",1),t(".user-postmenu a:eq(3)").addClass("active")},"posts/pending/:paged":function(n){e("pending",n),t(".user-postmenu a:eq(3)").addClass("active")},"posts/draft":function(){e("draft",1),t(".user-postmenu a:eq(4)").addClass("active")},"posts/draft/:paged":function(n){e("draft",n),t(".user-postmenu a:eq(4)").addClass("active")},"posts/trash":function(){e("trash",1),t(".user-postmenu a:eq(5)").addClass("active")},"posts/trash/:paged":function(n){e("trash",n),t(".user-postmenu a:eq(5)").addClass("active")},comments:function(){n(1)},"comments/:paged":function(t){n(t)},info:function(){s("info"),a(u),l?u.html(t("#temp-info").render(l)):t.ajax({url:c,type:"POST",dataType:"json",data:{action:"info"},success:function(e,n,s){e.user?(l=e.user,u.html(t("#temp-info").render(e.user))):a(u,d[1101])},error:function(t,e,n){a(u,d[1079])}})},password:function(){s("password"),u.html(t("#temp-password").render())},"post-new":function(){s("post-new"),u.html(t("#temp-postnew").render()),t(".user-main").hide(),t(".user-main-postnew").show()}},f=Router(m);f.configure({on:function(){location.hash.indexOf("posts/")<=0&&t(".user-postmenu").remove()},before:function(){t(".user-main").show(),t(".user-main-postnew").hide()},notfound:function(){location.hash="posts/all"}}),f.init(),location.hash||(location.hash="posts/all");var h;t(".container-user").on("click",function(e){var n=(e=e||window.event).target||e.srcElement,s=t(n);s.parent().attr("evt")?s=t(s.parent()[0]):s.parent().parent().attr("evt")&&(s=t(s.parent().parent()[0]));var a=s.attr("evt");if(a&&!s.hasClass("disabled"))switch(a){case"postnew.submit":p=(d=s.parent().parent().parent()).serializeObject();if(!window.tinyMCE)return void o("数据异常");p.post_content=tinyMCE.activeEditor.getContent();var i=t.trim(p.post_title),r=t.trim(p.post_url),u=t.trim(p.post_content);if(!i||i.length>50)return void o("标题不能为空，且小于50个字符");if(!u||u.length>1e4||u.length<10)return void o("文章内容不能为空，且介于10-10000字之间");if(!r&&r.length>200)return void o("来源链接不能大于200个字符");t.ajax({type:"POST",url:c,data:p,dataType:"json",success:function(t){t.msg&&o(t.msg),t.error||(d.find(".form-control").val(""),location.hash="posts/pending")}});break;case"password.submit":if(!(p=(d=s.parent().parent().parent()).serializeObject()).action)return;if(!t.trim(p.passwordold))return void o("请输入原密码");if(!p.password||p.password.length<6)return void o("新密码不能为空且至少6位");if(p.password!==p.password2)return void o("两次密码输入不一致");if(p.passwordold===p.password)return void o("新密码和原密码不能相同");t.ajax({type:"POST",url:c,data:p,dataType:"json",success:function(e){e.error?e.msg&&o(e.msg):(o("修改成功！下次登录请使用新密码！"),t("input:password").val(""))}});break;case"info.submit":var p,d=s.parent().parent().parent();if(!(p=d.serializeObject()).action)return;if(!/.{2,20}$/.test(p.nickname))return void o("昵称限制在2-20字内");if(p.url&&(!TBUI.is_url(p.url)||p.url.length>100))return void o("网址格式错误");if(p.qq&&!TBUI.is_qq(p.qq))return void o("QQ格式错误");if(p.weixin&&p.weixin.length>30)return void o("微信字数过长，限制在30字内");if(p.weibo&&(!TBUI.is_url(p.weibo)||p.weibo.length>100))return void o("微博格式错误");t.ajax({type:"POST",url:c,data:p,dataType:"json",success:function(t){t.error?t.msg&&o(t.msg):(o("修改成功！"),l=null)}})}})}(jQuery)}}});